apiVersion: skaffold/v1
kind: Config
build:
  local:
    push: false
  artifacts:
  - image: catarse-deploy/catarse-db
    context: ./services/service-core-db/
    docker:
      dockerfile: ./Dockerfile.db       
  - image: catarse-deploy/moments-db
    context: ./services/service-core-db/
    docker:
      dockerfile: ./Dockerfile.moments-db
  - image: catarse-deploy/core-db
    context: ./services/service-core-db/
    docker:
      dockerfile: ./Dockerfile.service_core-db
  - image: catarse-deploy/notification-dispatcher
    context: ./services/notification-service-api/
    docker:
      dockerfile: ./Dockerfile
  - image: catarse-deploy/payments
    context: ./services/payment-service-api/
    docker:
      dockerfile: ./Dockerfile
  - image: catarse-deploy/hook-service-api
    context: ./services/hook-service-api/
    docker:
      dockerfile: ./Dockerfile
  - image: catarse-deploy/catarse
    context: ./services/catarse/
    docker:
      buildArgs:
        NPM_AUTH: '{{ .NPM_AUTH }}'
      dockerfile: ./dev.Dockerfile  
  - image: catarse-deploy/recommender-service-api
    context: ./services/catarse_recommender/
    docker:
      dockerfile: ./catarse_recommender/Dockerfile 
  - image: catarse-deploy/common-docs
    context: ./services/common/
    docker:
      dockerfile: ./Dockerfile 
  - image: catarse-deploy/common-proxy
    context: ./services/proxy/
    docker:
      dockerfile: ./Dockerfile 
  - image: catarse-deploy/common-api
    context: ./services/common-api/
    docker:
      dockerfile: ./Dockerfile         
deploy:
  kustomize:
    path: infrastructure/kustomize/overlays/local-run
profiles:
- name: migrations
  build:
    artifacts:
    - image: catarse-deploy/catarse
      context: ./services/catarse/
      docker:
        buildArgs:
          NPM_AUTH: '{{ .NPM_AUTH }}'
        dockerfile: ./dev.Dockerfile        
    - image: catarse-deploy/migrations
      context: ./services/service-core-db/
      docker:
        dockerfile: ./Dockerfile     
  deploy:
    kustomize:
      path: infrastructure/kustomize/overlays/local-migrations
- name: catarse
  build:
    artifacts:
      - image: catarse-deploy/catarse
        context: ./services/catarse/
        docker:
          network: 'host'
          buildArgs:
            NPM_AUTH: '{{ .NPM_AUTH }}'
          dockerfile: ./dev.Dockerfile  
  deploy:
    kustomize:
      path: infrastructure/kustomize/overlays/local-catarse
- name: prime
  build:
    artifacts:
      - image: catarse-deploy/core-db
        context: ./services/service-core-db/
        docker:
          dockerfile: ./Dockerfile.service_core-db
  deploy:
    kustomize:
      path: infrastructure/kustomize/overlays/local-prime
- name: setup
  build:
    artifacts:
      - image: catarse-deploy/catarse
        context: ./services/catarse/
        docker:
          network: 'host'
          buildArgs:
            NPM_AUTH: '{{ .NPM_AUTH }}'
          dockerfile: ./dev.Dockerfile 
  deploy:
    kustomize:
      path: infrastructure/kustomize/overlays/local-setup         
